{% extends 'base.html' %}

{% block title %}–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - Electronica Store{% endblock %}

{% block content %}
<div class="header-nav">
    <a href="{% url 'main:index' %}" class="nav-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
</div>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-decoration">
            <div class="auth-icon">üîê</div>
        </div>

        <h1 class="auth-title">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h1>
        <p class="auth-subtitle">–£–∫–∞–∂–∏—Ç–µ email –∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å</p>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" class="auth-form" id="password-reset-form">
            {% csrf_token %}

            {% if form.errors %}
            <div class="alert alert-error">
                ‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –Ω–∏–∂–µ.
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-group">
                <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π id -->
                <label for="{{ form.email.id_for_label }}" class="form-label">
                    üìß Email –∞–¥—Ä–µ—Å
                </label>
                {{ form.email }}
                {% if form.email.errors %}
                <div class="error-text">
                    {{ form.email.errors }}
                </div>
                {% endif %}
                <small class="form-help">‚Ä¢ –í–≤–µ–¥–∏—Ç–µ email, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</small>
            </div>

            <div class="form-group">
                <div id="question-container" style="display: none; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <strong>–°–µ–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å:</strong> <span id="secret-question-text"></span>
                </div>

                <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π id -->
                <label for="{{ form.secret_answer.id_for_label }}" class="form-label">
                    üîê –û—Ç–≤–µ—Ç –Ω–∞ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å
                </label>
                {{ form.secret_answer }}
                {% if form.secret_answer.errors %}
                <div class="error-text">
                    {{ form.secret_answer.errors }}
                </div>
                {% endif %}
                <small class="form-help" id="answer-help">‚Ä¢ –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ email –≤—ã—à–µ</small>
            </div>

            <button type="submit" class="auth-button" id="submit-btn" disabled>
                üîó –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            </button>
        </form>

        <div class="auth-links">
            <p><a href="{% url 'users:login' %}" class="auth-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É</a></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º id
    const emailInput = document.querySelector('input[name="email"]');
    const answerInput = document.querySelector('input[name="secret_answer"]');
    const questionContainer = document.getElementById('question-container');
    const questionText = document.getElementById('secret-question-text');
    const answerHelp = document.getElementById('answer-help');
    const submitBtn = document.getElementById('submit-btn');

    if (!emailInput || !answerInput) {
        console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è —Ñ–æ—Ä–º—ã');
        return;
    }

    // –î–µ–±–∞—É–Ω—Å –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–ø—Ä–æ—Å–∞
    let debounceTimer;
    emailInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const email = this.value.trim();

        if (email.length < 5 || !email.includes('@')) {
            resetForm();
            return;
        }

        debounceTimer = setTimeout(() => {
            getSecretQuestion(email);
        }, 500); // –ñ–¥–µ–º 0.5 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–≤–æ–¥–∞
    });

    function getSecretQuestion(email) {
        fetch('{% url "users:get_secret_question" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'email=' + encodeURIComponent(email)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
                questionText.textContent = data.question;
                questionContainer.style.display = 'block';

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
                answerInput.disabled = false;
                answerInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤—ã—à–µ';
                answerInput.focus();

                // –ú–µ–Ω—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                answerHelp.textContent = '‚Ä¢ –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å';

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                submitBtn.disabled = false;
            } else {
                resetForm();
                answerHelp.textContent = '‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω';
                answerHelp.style.color = '#e74c3c';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resetForm();
        });
    }

    function resetForm() {
        questionContainer.style.display = 'none';
        questionText.textContent = '';
        answerInput.disabled = true;
        answerInput.value = '';
        answerInput.placeholder = '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ email';
        answerHelp.textContent = '‚Ä¢ –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ email –≤—ã—à–µ';
        answerHelp.style.color = '';
        submitBtn.disabled = true;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    resetForm();
});
</script>
{% endblock %}