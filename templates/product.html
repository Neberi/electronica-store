{% extends 'base.html' %}
{% load math_filters %}
{% load static %}

{% block title %}{{ product.title }}{% endblock %}

{% block extra_css %}
<style>
/* ===== –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ===== */
.product-header {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 40px;
    margin-bottom: 40px;
}

@media (max-width: 992px) {
    .product-header {
        grid-template-columns: 1fr;
        gap: 30px;
    }
}

/* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ */
.product-image-section {
    position: sticky;
    top: 20px;
    background: white;
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.product-image {
    position: relative;
    width: 100%;
    height: 400px;
    overflow: hidden;
    border-radius: 12px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    margin-bottom: 20px;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.5s ease;
}

.product-image:hover img {
    transform: scale(1.03);
}

.image-caption {
    font-size: 0.9rem;
    color: #7f8c8d;
    text-align: center;
    margin-top: 15px;
    font-style: italic;
}

/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ */
.product-main-info {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.page-title {
    font-size: 2.5rem;
    color: #2c3e50;
    margin: 0 0 10px 0;
    font-weight: 700;
    line-height: 1.2;
}

.product-subtitle {
    font-size: 1.2rem;
    color: #3498db;
    margin-bottom: 25px;
    font-weight: 500;
}

/* –ë–µ–π–¥–∂–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ */
.product-features {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 30px;
}

.feature-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* –†–µ–π—Ç–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ */
.product-rating {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 25px;
}

.rating-stars {
    display: flex;
    gap: 3px;
}

.star {
    font-size: 1.5rem;
    color: #f1c40f;
}

.star.empty {
    color: #ecf0f1;
}

.rating-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2c3e50;
}

.rating-count {
    color: #7f8c8d;
    font-size: 1rem;
}

/* –°–µ—Ç–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ */
.specs-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

.spec-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #3498db;
}

.spec-label {
    font-weight: 600;
    color: #2c3e50;
}

.spec-value {
    color: #7f8c8d;
    font-weight: 500;
}

.specs-link {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 15px;
}

.doc-link {
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* ===== –°–ï–ö–¶–ò–Ø –¶–ï–ù–´ –ò –ü–û–ö–£–ü–ö–ò ===== */
.price-section {
    background: white;
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.stock-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
}

.stock-badge {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.95rem;
    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.2);
}

.stock-badge.out-of-stock {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
}

.stock-details {
    color: #7f8c8d;
    font-size: 0.95rem;
}

/* –¶–µ–Ω–∞ —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏ */
.price-main {
    margin-bottom: 30px;
    padding-bottom: 25px;
    border-bottom: 2px solid #ecf0f1;
}

.price-wrapper {
    display: flex;
    align-items: baseline;
    gap: 15px;
    flex-wrap: wrap;
}

.price {
    font-size: 3rem;
    font-weight: 800;
    color: #2c3e50;
    display: block;
    margin-bottom: 5px;
}

.old-price {
    font-size: 1.8rem;
    color: #95a5a6;
    text-decoration: line-through;
    font-weight: 600;
}

.discount-badge {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 1.1rem;
}

.quantity-discount-info {
    margin-top: 10px;
    color: #27ae60;
    font-weight: 600;
}

.price-note {
    color: #7f8c8d;
    font-size: 1rem;
    margin-top: 5px;
}

/* –°–µ–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ */
.purchase-section {
    margin: 30px 0;
}

.quantity-section {
    margin-bottom: 20px;
}

.quantity-label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.1rem;
}

.quantity-selector {
    display: flex;
    align-items: center;
    gap: 15px;
    max-width: 200px;
}

.quantity-input {
    width: 80px;
    padding: 12px 15px;
    border: 2px solid #3498db;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    transition: all 0.3s ease;
}

.quantity-input:focus {
    border-color: #2980b9;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    outline: none;
}

.quantity-plus {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    user-select: none;
}

.quantity-plus:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.total-section {
    margin: 25px 0;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.total-price {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2c3e50;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.discount-breakdown {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #27ae60;
}

/* –ö–Ω–æ–ø–∫–∏ */
.add-to-cart-btn {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    color: white;
    border: none;
    padding: 18px 40px;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.add-to-cart-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(39, 174, 96, 0.4);
}

.add-to-cart-btn.out-of-stock-btn {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    cursor: not-allowed;
    box-shadow: none;
}

.add-to-cart-btn.out-of-stock-btn:hover {
    transform: none;
    box-shadow: none;
}

/* –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
.auth-required-section {
    margin: 25px 0;
}

.auth-required-message {
    display: flex;
    align-items: center;
    gap: 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.auth-icon {
    font-size: 3.5rem;
}

.auth-text h3 {
    margin: 0 0 10px 0;
    color: white;
    font-size: 1.5rem;
}

.auth-text p {
    margin: 0 0 20px 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.auth-buttons {
    display: flex;
    gap: 15px;
}

.auth-btn {
    padding: 12px 30px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.login-btn {
    background: #f1c40f;
    color: #2c3e50;
}

.register-btn {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 2px solid rgba(255,255,255,0.4);
}

.auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* –û–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã */
.bulk-prices {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    border-radius: 12px;
    margin: 25px 0;
    border: 1px solid #dee2e6;
}

.bulk-prices h4 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.bulk-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    color: #555;
    font-size: 1.05rem;
    transition: all 0.3s ease;
    border-radius: 6px;
    margin-bottom: 5px;
}

.bulk-item:hover {
    background: #f8f9fa;
}

.bulk-item.active {
    background: #d4edda;
    border-left: 3px solid #27ae60;
    padding-left: 12px;
}

.bulk-item strong {
    color: #2c3e50;
    font-weight: 700;
}

.bulk-discount {
    color: #27ae60;
    font-size: 0.9rem;
    margin-left: 5px;
    font-weight: 600;
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Å—Ç–∞–≤–∫–µ */
.notification-info {
    display: flex;
    align-items: center;
    gap: 20px;
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 1px solid #ffeaa7;
    border-radius: 12px;
    padding: 20px;
    margin-top: 25px;
}

.notification-icon {
    font-size: 2rem;
}

.notification-info p {
    margin: 0;
    color: #856404;
    font-size: 1.05rem;
}

.notification-info a {
    color: #3498db;
    font-weight: 700;
    text-decoration: none;
}

.notification-info a:hover {
    text-decoration: underline;
}

/* ===== –°–ï–ö–¶–ò–Ø –û–¢–ó–´–í–û–í ===== */
.reviews-section {
    background: white;
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.reviews-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.reviews-stats {
    display: flex;
    align-items: center;
    gap: 20px;
}

.avg-rating-box {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 15px 25px;
    border-radius: 12px;
    text-align: center;
}

.avg-rating-value {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 5px;
}

.avg-rating-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.rating-distribution {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.rating-bar {
    display: flex;
    align-items: center;
    gap: 10px;
}

.rating-stars-small {
    display: flex;
    gap: 2px;
    width: 80px;
}

.star-small {
    font-size: 0.9rem;
    color: #f1c40f;
}

.star-small.empty {
    color: #ecf0f1;
}

.bar-container {
    width: 150px;
    height: 8px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    background: linear-gradient(135deg, #f1c40f, #f39c12);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.rating-count {
    min-width: 20px;
    text-align: right;
    font-size: 0.9rem;
    color: #7f8c8d;
}

.write-review-btn {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.write-review-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
}

/* –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ */
.review-form-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid #dee2e6;
}

.rating-selector {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
}

.rating-star-select {
    font-size: 2rem;
    color: #ecf0f1;
    cursor: pointer;
    transition: color 0.2s;
}

.rating-star-select.active {
    color: #f1c40f;
}

.form-row {
    margin-bottom: 15px;
}

.form-input {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s;
}

.form-input:focus {
    border-color: #3498db;
    outline: none;
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.review-form-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

.submit-review-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
}

.submit-review-btn:hover {
    background: #2980b9;
}

.cancel-review-btn {
    background: #95a5a6;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
}

.cancel-review-btn:hover {
    background: #7f8c8d;
}

/* –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ */
.reviews-list {
    margin-top: 30px;
}

.review-item {
    border-bottom: 1px solid #ecf0f1;
    padding: 25px 0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.review-user {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
}

.user-name {
    font-weight: 600;
    color: #2c3e50;
}

.review-meta {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.review-content {
    line-height: 1.6;
    color: #444;
}

.review-title {
    font-weight: 600;
    margin-bottom: 10px;
    color: #2c3e50;
}

.no-reviews {
    text-align: center;
    padding: 40px 20px;
    color: #7f8c8d;
    font-size: 1.1rem;
}

.reviews-pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 30px;
}

.page-btn {
    padding: 8px 15px;
    background: #ecf0f1;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.page-btn.active {
    background: #3498db;
    color: white;
}

.page-btn:hover:not(.active) {
    background: #d5dbdb;
}

/* ===== –û–ü–ò–°–ê–ù–ò–ï –¢–û–í–ê–†–ê ===== */
.product-description-section {
    background: white;
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.section-title {
    font-size: 1.8rem;
    color: #2c3e50;
    margin: 0 0 25px 0;
    font-weight: 700;
    padding-bottom: 15px;
    border-bottom: 3px solid #3498db;
}

.description-content {
    font-size: 1.05rem;
    line-height: 1.7;
    color: #444;
}

.description-content h3 {
    color: #2c3e50;
    margin: 25px 0 15px 0;
    font-size: 1.4rem;
}

/* –°–ø–∏—Å–æ–∫ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π */
.features-list {
    list-style: none;
    padding: 0;
    margin: 20px 0;
}

.features-list li {
    padding: 12px 0;
    position: relative;
    padding-left: 35px;
    font-size: 1.05rem;
}

.features-list li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: #27ae60;
    font-weight: bold;
    font-size: 1.2rem;
    background: #d4edda;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è */
.package-items {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.package-item {
    padding: 8px 0;
    font-size: 1.05rem;
    color: #555;
}

/* –°–µ–∫—Ü–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ */
.delivery-section {
    background: white;
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
}

.delivery-region {
    font-size: 1.1rem;
    color: #3498db;
    margin-bottom: 20px;
    font-weight: 600;
}

.delivery-table-container {
    overflow-x: auto;
    margin-bottom: 20px;
}

.delivery-table {
    width: 100%;
    border-collapse: collapse;
}

.delivery-table th {
    background: #f8f9fa;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #dee2e6;
}

.delivery-table td {
    padding: 15px;
    border-bottom: 1px solid #ecf0f1;
}

.delivery-table tr:hover {
    background: #f8f9fa;
}

.free-delivery {
    color: #27ae60;
    font-weight: 600;
}

.delivery-notes {
    margin-top: 15px;
    color: #7f8c8d;
    font-size: 0.9rem;
}

/* ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø ===== */
.navigation {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #ecf0f1;
    flex-wrap: wrap;
}

.nav-link {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 15px 30px;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1.05rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
}

.nav-link:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
}

/* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
.custom-notification {
    position: fixed;
    top: 30px;
    right: 30px;
    z-index: 10000;
    min-width: 350px;
    max-width: 500px;
    animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.notification-content {
    background: white;
    padding: 20px 25px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-left: 5px solid #3498db;
    position: relative;
    overflow: hidden;
}

.notification-content:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #3498db, transparent);
}

.notification-success .notification-content {
    border-left-color: #27ae60;
}

.notification-success .notification-content:before {
    background: linear-gradient(90deg, #27ae60, transparent);
}

.notification-error .notification-content {
    border-left-color: #e74c3c;
}

.notification-error .notification-content:before {
    background: linear-gradient(90deg, #e74c3c, transparent);
}

.notification-message {
    flex: 1;
    font-weight: 600;
    font-size: 1.05rem;
}

.notification-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #7f8c8d;
    margin-left: 15px;
    transition: color 0.3s ease;
}

.notification-close:hover {
    color: #2c3e50;
}

@keyframes slideIn {
    from {
        transform: translateX(100%) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(0) translateY(0);
        opacity: 1;
    }
}

/* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
@media (max-width: 768px) {
    .product-header {
        gap: 25px;
    }

    .product-image-section,
    .product-main-info,
    .price-section,
    .product-description-section,
    .delivery-section,
    .reviews-section {
        padding: 20px;
        border-radius: 12px;
    }

    .page-title {
        font-size: 2rem;
    }

    .price {
        font-size: 2.5rem;
    }

    .old-price {
        font-size: 1.5rem;
    }

    .specs-grid {
        grid-template-columns: 1fr;
    }

    .auth-required-message {
        flex-direction: column;
        text-align: center;
        gap: 20px;
        padding: 25px;
    }

    .auth-buttons {
        justify-content: center;
        flex-wrap: wrap;
    }

    .reviews-header {
        flex-direction: column;
        align-items: stretch;
    }

    .reviews-stats {
        flex-direction: column;
        align-items: stretch;
    }

    .rating-bar {
        justify-content: space-between;
    }

    .navigation {
        flex-direction: column;
        align-items: stretch;
    }

    .nav-link {
        justify-content: center;
        text-align: center;
    }

    .custom-notification {
        min-width: calc(100vw - 40px);
        max-width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="product-header">
    <div class="product-image-section">
        <div class="product-image">
            {% if product.image %}
                <img src="{% static 'img/' %}{{ product.image }}" alt="{{ product.title }}"
                     onerror="this.src='{% static 'img/core407v.jpg' %}'">
            {% else %}
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 3rem; color: #bdc3c7;">
                    üì∑
                </div>
            {% endif %}
        </div>
        <p class="image-caption">
            –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ª—É–∂–∞—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è
        </p>
    </div>

    <div class="product-main-info">
        <h1 class="page-title">{{ product.title }}</h1>
        <p class="product-subtitle">
            {% if product.subtitle %}
                {{ product.subtitle }}
            {% else %}
                –í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
            {% endif %}
        </p>

        <!-- –†–µ–π—Ç–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞ -->
        <div class="product-rating">
            <div class="rating-stars">
                {% for i in "12345" %}
                    {% if forloop.counter <= product_rating.avg|default:0 %}
                        <span class="star">‚òÖ</span>
                    {% else %}
                        <span class="star empty">‚òÜ</span>
                    {% endif %}
                {% endfor %}
            </div>
            <span class="rating-value">{{ product_rating.avg|default:"0.0"|floatformat:1 }}</span>
            <span class="rating-count">({{ product_rating.count|default:0 }} –æ—Ç–∑—ã–≤–æ–≤)</span>
        </div>

        <div class="product-features">
            {% if product.features %}
                {% for feature in product.features %}
                <div class="feature-badge">
                    {% if feature.icon %}{{ feature.icon }}{% endif %} {{ feature.name }}
                </div>
                {% endfor %}
            {% else %}
                <!-- –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –±–µ–π–¥–∂–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ features -->
                <div class="feature-badge">‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ</div>
                <div class="feature-badge">‚ö° –ì–∞—Ä–∞–Ω—Ç–∏—è</div>
                <div class="feature-badge">üöö –î–æ—Å—Ç–∞–≤–∫–∞</div>
            {% endif %}
        </div>

        <div class="specs-grid">
            {% if product.specs %}
                {% for spec in product.specs %}
                <div class="spec-item">
                    <span class="spec-label">{{ spec.label }}</span>
                    <span class="spec-value">{{ spec.value }}</span>
                </div>
                {% endfor %}
            {% else %}
                <!-- –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                <div class="spec-item">
                    <span class="spec-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                    <span class="spec-value">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</span>
                    <span class="spec-value">–ò–∑–≤–µ—Å—Ç–Ω—ã–π –±—Ä–µ–Ω–¥</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">–°—Ç—Ä–∞–Ω–∞:</span>
                    <span class="spec-value">–†–æ—Å—Å–∏—è</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">–ì–∞—Ä–∞–Ω—Ç–∏—è:</span>
                    <span class="spec-value">12 –º–µ—Å—è—Ü–µ–≤</span>
                </div>
            {% endif %}
        </div>

        {% if product.docs %}
        <div class="specs-link">
            <a href="#" class="nav-link" style="padding: 10px 20px; font-size: 0.9rem;">üìÑ –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</a>
            <span class="doc-link">{{ product.docs }}</span>
        </div>
        {% endif %}
    </div>
</div>

<div class="price-section">
    <div class="stock-info">
        {% if product.in_stock > 0 %}
            <span class="stock-badge">‚úî –í –Ω–∞–ª–∏—á–∏–∏</span>
            <span class="stock-details">
                {% if product.stock_details %}
                    {{ product.stock_details }}
                {% else %}
                    –î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞
                {% endif %}
            </span>
        {% else %}
            <span class="stock-badge out-of-stock">‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
            <span class="stock-details">
                {% if product.stock_details %}
                    {{ product.stock_details }}
                {% else %}
                    –°–∫–æ—Ä–æ –±—É–¥–µ—Ç –Ω–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞
                {% endif %}
            </span>
        {% endif %}
    </div>

    <div class="price-main">
        <div class="price-wrapper">
            {% if product_quantity_discount > 0 %}
                <span class="old-price">{{ product.price }} ‚ÇΩ</span>
                <span class="price" id="discounted-price">{{ discounted_price|default:product.price|floatformat:0 }} ‚ÇΩ</span>
                <span class="discount-badge">-{{ product_quantity_discount }}%</span>
            {% else %}
                <span class="price">{{ product.price }} ‚ÇΩ</span>
            {% endif %}
        </div>

        {% if product_quantity_discount > 0 %}
            <div class="quantity-discount-info" id="discount-info">
                ‚ö° –°–∫–∏–¥–∫–∞ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ product_quantity_discount }}%
            </div>
        {% endif %}

        <span class="price-note">–∑–∞ —à—Ç.</span>
    </div>

    {% if product.in_stock > 0 %}
        {% if user.is_authenticated %}
        <div class="purchase-section">
            <div class="quantity-section">
                <label class="quantity-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                <div class="quantity-selector">
                    <input type="number" class="quantity-input" value="1" min="1" max="999" id="quantity-input">
                    <span class="quantity-plus">+</span>
                </div>
            </div>

            <div class="total-section">
                <div class="total-price">
                    –ò—Ç–æ–≥–æ:
                    <strong id="total-price">
                        {% if product_quantity_discount > 0 %}
                            {{ discounted_price|default:product.price|floatformat:0 }} ‚ÇΩ
                        {% else %}
                            {{ product.price }} ‚ÇΩ
                        {% endif %}
                    </strong>
                </div>
                {% if product_quantity_discount > 0 %}
                    <div class="discount-breakdown" id="savings-info">
                        ‚ö° –í–∞—à–∞ —ç–∫–æ–Ω–æ–º–∏—è: <strong id="savings-amount">0 ‚ÇΩ</strong>
                    </div>
                {% endif %}
            </div>

            <button class="add-to-cart-btn" onclick="addToCart('{{ product.id }}')" id="add-to-cart-btn">
                üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
            </button>
        </div>
        {% else %}
        <div class="auth-required-section">
            <div class="auth-required-message">
                <div class="auth-icon">üîí</div>
                <div class="auth-text">
                    <h3>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                    <p>–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</p>
                    <div class="auth-buttons">
                        <a href="{% url 'users:login' %}" class="auth-btn login-btn">üîë –í–æ–π—Ç–∏</a>
                        <a href="{% url 'users:register' %}" class="auth-btn register-btn">‚ú® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="purchase-section">
            <div class="quantity-section">
                <label class="quantity-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                <div class="quantity-selector">
                    <input type="number" class="quantity-input" value="1" min="1" id="quantity-input" disabled>
                    <span class="quantity-plus" style="opacity: 0.5;">+</span>
                </div>
            </div>

            <div class="total-section">
                <div class="total-price">–ò—Ç–æ–≥–æ: <strong>{{ product.price }} ‚ÇΩ</strong></div>
            </div>

            <button class="add-to-cart-btn out-of-stock-btn" disabled>
                üì¶ –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
            </button>
        </div>
    {% endif %}

{% if product.in_stock > 0 %}
<div class="bulk-prices">
    <h4>üì¶ –û–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã:</h4>

    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–∏–¥–æ–∫ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
    <div class="bulk-item" data-quantity="4">
        –æ—Ç 4 —à—Ç. ‚Äî
        <strong>
            <span class="bulk-price">
                {{ product.price|multiply:0.95|floatformat:0 }} ‚ÇΩ
            </span>
            <span class="bulk-discount">(-5%)</span>
        </strong>
    </div>

    <div class="bulk-item" data-quantity="7">
        –æ—Ç 7 —à—Ç. ‚Äî
        <strong>
            <span class="bulk-price">
                {{ product.price|multiply:0.9|floatformat:0 }} ‚ÇΩ
            </span>
            <span class="bulk-discount">(-10%)</span>
        </strong>
    </div>

    <div class="bulk-item" data-quantity="10">
        –æ—Ç 10 —à—Ç. ‚Äî
        <strong>
            <span class="bulk-price">
                {{ product.price|multiply:0.85|floatformat:0 }} ‚ÇΩ
            </span>
            <span class="bulk-discount">(-15%)</span>
        </strong>
    </div>

    <!-- –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ -->
    <div class="current-quantity-info" id="current-quantity-info" style="display: none; margin-top: 15px; padding: 10px; background: #e8f4fc; border-radius: 8px;">
        <strong>–í–∞—à–∞ —Ü–µ–Ω–∞ –∑–∞ <span id="selected-quantity">1</span> —à—Ç.:</strong>
        <span id="current-quantity-price">{{ product.price }} ‚ÇΩ</span>
        <span id="current-quantity-discount" style="color: #27ae60; font-weight: 600;"></span>
    </div>
</div>
{% endif %}

    {% if product.in_stock == 0 %}
    <div class="notification-info">
        <div class="notification-icon">üí°</div>
        <p>–•–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞? <a href="{% url 'main:contacts' %}">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</a></p>
    </div>
    {% endif %}
</div>

<!-- –°–µ–∫—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ -->
<div class="reviews-section" id="reviews-section">
    <div class="reviews-header">
        <h2 class="section-title">üìù –û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π</h2>

        <div class="reviews-stats">
            <div class="avg-rating-box">
                <div class="avg-rating-value">{{ product_rating.avg|default:"0.0"|floatformat:1 }}</div>
                <div class="avg-rating-label">—Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div>
            </div>

            <div class="rating-distribution">
    {% for star in "54321" %}
    {% with star_int=star|add:"0" %}
    <div class="rating-bar">
        <div class="rating-stars-small">
            {% for i in "12345" %}
                {% if forloop.counter <= star_int %}
                    <span class="star-small">‚òÖ</span>
                {% else %}
                    <span class="star-small empty">‚òÜ</span>
                {% endif %}
            {% endfor %}
        </div>
        <div class="bar-container">
            {% with count=product_rating.distribution|get_item:star_int %}
            {% with total=product_rating.count|default:1 %}
            {% with percentage=count|divide:total|multiply:100|floatformat:0 %}
            <div class="bar-fill" style="width: {{ percentage|default:0 }}%"></div>
            {% endwith %}
            {% endwith %}
            {% endwith %}
        </div>
        <span class="rating-count">
            {{ product_rating.distribution|get_item:star_int|default:0 }}
        </span>
    </div>
    {% endwith %}
    {% endfor %}
</div>
        </div>

        {% if user.is_authenticated and product.in_stock > 0 %}
            <button class="write-review-btn" onclick="toggleReviewForm()">‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤</button>
        {% endif %}
    </div>

    <!-- –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    {% if user.is_authenticated %}
    <div class="review-form-section" id="review-form-section" style="display: none;">
        <h3>–í–∞—à –æ—Ç–∑—ã–≤ –æ —Ç–æ–≤–∞—Ä–µ</h3>
        <form id="review-form">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">

            <div class="rating-selector" id="rating-selector">
                <span class="rating-star-select" data-rating="1">‚òÜ</span>
                <span class="rating-star-select" data-rating="2">‚òÜ</span>
                <span class="rating-star-select" data-rating="3">‚òÜ</span>
                <span class="rating-star-select" data-rating="4">‚òÜ</span>
                <span class="rating-star-select" data-rating="5">‚òÜ</span>
                <span style="margin-left: 10px; font-weight: 600;" id="selected-rating-text">–û—Ü–µ–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä</span>
            </div>

            <input type="hidden" name="rating" id="rating-input" value="">

            <div class="form-row">
                <input type="text" class="form-input" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–∑—ã–≤–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required>
            </div>

            <div class="form-row">
                <textarea class="form-input form-textarea" name="text" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" required></textarea>
            </div>

            <div class="review-form-actions">
                <button type="submit" class="submit-review-btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                <button type="button" class="cancel-review-btn" onclick="toggleReviewForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
    <div class="reviews-list" id="reviews-list">
        {% if reviews %}
            {% for review in reviews %}
            <div class="review-item">
                <div class="review-header">
                    <div class="review-user">
                        <div class="user-avatar">
                            {{ review.user.username|slice:":1"|upper }}
                        </div>
                        <span class="user-name">{{ review.user.username }}</span>
                    </div>
                    <div class="review-meta">
                        <div class="rating-stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <span class="star" style="font-size: 1.2rem;">‚òÖ</span>
                                {% else %}
                                    <span class="star empty" style="font-size: 1.2rem;">‚òÜ</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span>{{ review.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                </div>
                <div class="review-content">
                    <div class="review-title">{{ review.title }}</div>
                    <p>{{ review.text }}</p>
                </div>
            </div>
            {% endfor %}

            {% if total_reviews > 5 %}
            <div class="reviews-pagination">
                <button class="page-btn active">1</button>
                <button class="page-btn">2</button>
                <button class="page-btn">3</button>
            </div>
            {% endif %}
        {% else %}
            <div class="no-reviews">
                <p style="font-size: 1.2rem; margin-bottom: 10px;">üòä –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>
                <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç –æ—Ç–∑—ã–≤ –æ–± —ç—Ç–æ–º —Ç–æ–≤–∞—Ä–µ!</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="product-description-section">
    <h2 class="section-title">üìã –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
    <div class="description-content">
        <p>{{ product.description }}</p>

        {% if product.application_areas %}
        <h3>–û–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:</h3>
        <ul class="features-list">
            {% for area in product.application_areas %}
            <li>{{ area }}</li>
            {% endfor %}
        </ul>
        {% endif %}

        {% if product.package_info %}
        <h3>–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è:</h3>
        <div class="package-items">
            {% for item in product.package_info %}
            <div class="package-item">‚Ä¢ {{ item }}</div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

{% if product.delivery_info %}
<div class="delivery-section">
    <h2 class="section-title">üöö –°—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
    <p class="delivery-region">{{ product.delivery_region|default:"–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏" }}</p>

    <div class="delivery-table-container">
        <table class="delivery-table">
            <thead>
                <tr>
                    <th>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                    <th>–°—Ä–æ–∫</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                </tr>
            </thead>
            <tbody>
                {% for delivery in product.delivery_info %}
                <tr>
                    <td>{{ delivery.method }}</td>
                    <td>{{ delivery.term }}</td>
                    <td>
                        {% if delivery.price == 0 or delivery.price == "–±–µ—Å–ø–ª–∞—Ç–Ω–æ" %}
                        <span class="free-delivery">–±–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                        {% else %}
                        {{ delivery.price }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="delivery-notes">
        {% if product.delivery_notes %}
            {{ product.delivery_notes|safe }}
        {% else %}
            <p>* –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="navigation">
    <a href="{% url 'main:catalog' %}" class="nav-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
    <a href="{% url 'main:index' %}" class="nav-link">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    {% if user.is_authenticated and product.in_stock > 0 %}
        <a href="{% url 'main:personal_cabinet' %}" class="nav-link">üë§ –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
    {% elif not user.is_authenticated %}
        <a href="{% url 'users:login' %}" class="nav-link">üîë –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let selectedRating = 0;
let currentQuantity = 1;
let basePrice = {{ product.price }};
let quantityDiscount = {{ product_quantity_discount|default:0 }};
let discountedPrice = basePrice;

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Python –ª–æ–≥–∏–∫–æ–π)
function calculateQuantityDiscount(quantity) {
    if (quantity >= 10) return 15;
    if (quantity >= 7) return 10;
    if (quantity >= 4) return 5;
    return 0;
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã —Å–æ —Å–∫–∏–¥–∫–æ–π
function calculateDiscountedPrice(price, discount) {
    return price * (1 - discount / 100);
}

// –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
function formatPrice(price) {
    return Math.round(price).toLocaleString('ru-RU') + ' ‚ÇΩ';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É–º–º—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
function updateTotalPrice() {
    const quantityInput = document.getElementById('quantity-input');
    if (!quantityInput) return;

    const quantity = parseInt(quantityInput.value) || 1;
    if (quantity < 1) {
        quantityInput.value = 1;
        return;
    }
    if (quantity > 999) {
        quantityInput.value = 999;
        return;
    }

    currentQuantity = quantity;

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    const currentDiscount = calculateQuantityDiscount(quantity);

    // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–∫–∏–¥–∫–∏
    const discountedPriceElement = document.getElementById('discounted-price');
    const discountInfoElement = document.getElementById('discount-info');
    const discountBadge = document.querySelector('.discount-badge');
    const savingsInfoElement = document.getElementById('savings-info');
    const savingsAmountElement = document.getElementById('savings-amount');

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
    if (currentDiscount > 0 && discountedPriceElement) {
        discountedPrice = calculateDiscountedPrice(basePrice, currentDiscount);
        discountedPriceElement.textContent = formatPrice(discountedPrice);

        if (discountInfoElement) {
            discountInfoElement.style.display = 'block';
            discountInfoElement.textContent = `‚ö° –°–∫–∏–¥–∫–∞ –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${currentDiscount}%`;
        }

        if (discountBadge) {
            discountBadge.style.display = 'inline-block';
            discountBadge.textContent = `-${currentDiscount}%`;
        }
    } else {
        discountedPrice = basePrice;
        if (discountedPriceElement) {
            discountedPriceElement.textContent = formatPrice(basePrice);
        }
        if (discountInfoElement) {
            discountInfoElement.style.display = 'none';
        }
        if (discountBadge) {
            discountBadge.style.display = 'none';
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
    const totalPrice = discountedPrice * quantity;
    const totalPriceElement = document.getElementById('total-price');
    if (totalPriceElement) {
        totalPriceElement.textContent = formatPrice(totalPrice);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫–æ–Ω–æ–º–∏—é
    if (currentDiscount > 0 && savingsInfoElement && savingsAmountElement) {
        const savings = (basePrice * quantity) - totalPrice;
        savingsInfoElement.style.display = 'block';
        savingsAmountElement.textContent = formatPrice(savings);
    } else if (savingsInfoElement) {
        savingsInfoElement.style.display = 'none';
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–ø—Ç–æ–≤—ã—Ö —Ü–µ–Ω–∞—Ö
    updateBulkPriceHighlight(quantity);
}

// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ–ø—Ç–æ–≤–æ–π —Ü–µ–Ω—ã
function updateBulkPriceHighlight(quantity) {
    document.querySelectorAll('.bulk-item').forEach(item => {
        const bulkQuantity = parseInt(item.dataset.quantity) || 0;

        if (quantity >= bulkQuantity && bulkQuantity > 0) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ
    const infoElement = document.getElementById('current-quantity-info');
    const selectedQuantityElement = document.getElementById('selected-quantity');
    const currentPriceElement = document.getElementById('current-quantity-price');
    const currentDiscountElement = document.getElementById('current-quantity-discount');

    if (infoElement && selectedQuantityElement && currentPriceElement && currentDiscountElement) {
        const currentDiscount = calculateQuantityDiscount(quantity);
        const currentDiscountedPrice = calculateDiscountedPrice(basePrice, currentDiscount);

        infoElement.style.display = 'block';
        selectedQuantityElement.textContent = quantity;
        currentPriceElement.textContent = formatPrice(currentDiscountedPrice) + ' –∑–∞ —à—Ç.';

        if (currentDiscount > 0) {
            currentDiscountElement.textContent = ` (—Å–∫–∏–¥–∫–∞ ${currentDiscount}%)`;
            currentDiscountElement.style.display = 'inline';
        } else {
            currentDiscountElement.textContent = '';
            currentDiscountElement.style.display = 'none';
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity-input');
    const plusButton = document.querySelector('.quantity-plus');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–ª–µ–º–µ–Ω—Ç quantityInput
    if (!quantityInput) {
        console.log('–ü–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (—Ç–æ–≤–∞—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –≤ –Ω–∞–ª–∏—á–∏–∏)');
        return;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–∫–∏–¥–∫—É
    updateTotalPrice();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    quantityInput.addEventListener('change', updateTotalPrice);
    quantityInput.addEventListener('input', updateTotalPrice);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "+"
    if (plusButton) {
        plusButton.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value) || 1;
            if (currentValue < 999) {
                quantityInput.value = currentValue + 1;
                updateTotalPrice();
            }
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã)
    const ratingSelector = document.getElementById('rating-selector');
    if (ratingSelector) {
        initializeRatingSelector();
    }
});

// –°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤
function initializeRatingSelector() {
    const stars = document.querySelectorAll('.rating-star-select');
    stars.forEach(star => {
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.dataset.rating);
            highlightStars(rating);
        });

        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.rating);
            document.getElementById('rating-input').value = selectedRating;
            highlightStars(selectedRating);
            document.getElementById('selected-rating-text').textContent = `–û—Ü–µ–Ω–∫–∞: ${selectedRating}/5`;
        });
    });

    // –°–±—Ä–æ—Å –∑–≤–µ–∑–¥ –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏
    document.getElementById('rating-selector').addEventListener('mouseleave', function() {
        highlightStars(selectedRating);
    });
}

function highlightStars(rating) {
    const stars = document.querySelectorAll('.rating-star-select');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.textContent = '‚òÖ';
            star.classList.add('active');
        } else {
            star.textContent = '‚òÜ';
            star.classList.remove('active');
        }
    });
}

function toggleReviewForm() {
    const formSection = document.getElementById('review-form-section');
    if (formSection.style.display === 'none' || formSection.style.display === '') {
        formSection.style.display = 'block';
        window.scrollTo({
            top: formSection.offsetTop - 100,
            behavior: 'smooth'
        });
    } else {
        formSection.style.display = 'none';
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        document.getElementById('review-form').reset();
        selectedRating = 0;
        document.getElementById('rating-input').value = '';
        document.getElementById('selected-rating-text').textContent = '–û—Ü–µ–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä';
        highlightStars(0);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–∞
document.getElementById('review-form')?.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!selectedRating) {
        showNotification('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä', 'error');
        return;
    }

    const formData = new FormData(this);

    fetch('{% url "main:add_product_review" product.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –í–∞—à –æ—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
            toggleReviewForm();
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ—Ç–∑—ã–≤–∞
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('‚ùå ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞', 'error');
    });
});

function addToCart(productId) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    {% if not user.is_authenticated %}
        showNotification('‚ùå –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
        return;
    {% endif %}

    const quantityInput = document.getElementById('quantity-input');
    if (!quantityInput) {
        showNotification('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞', 'error');
        return;
    }

    const quantity = parseInt(quantityInput.value) || 1;
    const csrftoken = getCookie('csrftoken');

    fetch(`/cart/add/${productId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            const cartCountElement = document.querySelector('.cart-count');
            if (cartCountElement && data.cart_count !== undefined) {
                cartCountElement.textContent = data.cart_count;
            }
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    const existingNotifications = document.querySelectorAll('.custom-notification');
    existingNotifications.forEach(notification => notification.remove());

    const notification = document.createElement('div');
    notification.className = `custom-notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
        </div>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 4000);
}
</script>
{% endblock %}