{% extends 'admin_panel/base.html' %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ö–æ—Ä–∑–∏–Ω—ã{% endblock %}

{% block page_title %}üõí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω–∞–º–∏ ({{ cart_count }}){% endblock %}

{% block content %}
<div class="filters">
    <form method="get" class="filter-row">
        <div class="form-group">
            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <input type="text" name="user" class="form-control" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
                   value="{{ user_filter }}">
        </div>

        <div class="form-group">
            <label class="form-label">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</label>
            <select name="has_items" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="true" {% if has_items == 'true' %}selected{% endif %}>–° —Ç–æ–≤–∞—Ä–∞–º–∏</option>
                <option value="false" {% if has_items == 'false' %}selected{% endif %}>–ü—É—Å—Ç—ã–µ</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select name="sort_by" class="form-control">
                <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>–ù–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>–°—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                <option value="user__username" {% if sort_by == 'user__username' %}selected{% endif %}>–ü–æ –∏–º–µ–Ω–∏</option>
            </select>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary" style="height: 42px;">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="{% url 'main:admin_carts' %}" class="btn btn-secondary" style="height: 42px; margin-left: 10px;">
                –°–±—Ä–æ—Å–∏—Ç—å
            </a>
        </div>
    </form>
</div>

{% if carts %}
<table class="admin-table">
    <thead>
        <tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
            <th>–¢–æ–≤–∞—Ä–æ–≤</th>
            <th>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for cart in carts %}
        <tr>
            <td>
                <strong>{{ cart.user.username }}</strong><br>
                <small>{{ cart.user.email }}</small>
            </td>
            <td>{{ cart.created_at|date:"d.m.Y H:i" }}</td>
            <td><span class="badge">{{ cart.item_count }}</span></td>
            <td><span class="badge">{{ cart.total_items }}</span></td>
            <td>
                {% if cart.items.all %}
                    {{ cart.items.last.added_at|date:"d.m.Y H:i" }}
                {% else %}
                    –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤
                {% endif %}
            </td>
            <td>
                <form action="{% url 'main:delete_cart' cart.id %}" method="post" class="delete-form" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ cart.user.username }}?')">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </td>
        </tr>
        {% if cart.item_count > 0 %}
        <tr style="background: #f8f9fa;">
            <td colspan="6">
                <small><strong>–¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ:</strong></small><br>
                {% for item in cart.items.all %}
                <span style="display: inline-block; background: #e9ecef; padding: 2px 8px; border-radius: 10px; margin: 2px; font-size: 0.85rem;">
                    {{ item.product_id }} √ó {{ item.quantity }}
                </span>
                {% endfor %}
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

{% if carts.paginator.num_pages > 1 %}
<div class="pagination">
    {% if carts.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ carts.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </li>
    {% endif %}

    {% for num in carts.paginator.page_range %}
    {% if num > carts.number|add:-3 and num < carts.number|add:3 %}
    <li class="page-item">
        <a class="page-link {% if carts.number == num %}active{% endif %}"
           href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            {{ num }}
        </a>
    </li>
    {% endif %}
    {% endfor %}

    {% if carts.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ carts.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            –í–ø–µ—Ä–µ–¥ ‚Üí
        </a>
    </li>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="alert alert-info">
    üòê –ö–æ—Ä–∑–∏–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
</div>
{% endif %}
{% endblock %}