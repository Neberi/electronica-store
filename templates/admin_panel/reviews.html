{% extends 'admin_panel/base.html' %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –û—Ç–∑—ã–≤—ã{% endblock %}

{% block page_title %}‚≠ê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏ ({{ review_count }}){% endblock %}

{% block content %}
<div class="filters">
    <form method="get" class="filter-row">
        <div class="form-group">
            <label class="form-label">ID —Ç–æ–≤–∞—Ä–∞</label>
            <input type="text" name="product_id" class="form-control" placeholder="core407v, stlink-v2..."
                   value="{{ product_id }}">
        </div>

        <div class="form-group">
            <label class="form-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
            <input type="text" name="user" class="form-control" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
                   value="{{ user_filter }}">
        </div>

        <div class="form-group">
            <label class="form-label">–†–µ–π—Ç–∏–Ω–≥</label>
            <select name="rating" class="form-control">
                <option value="">–í—Å–µ</option>
                {% for value, label in RATING_CHOICES %}
                <option value="{{ value }}" {% if rating_filter == value|stringformat:"i" %}selected{% endif %}>
                    {{ label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
            <select name="is_approved" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="true" {% if is_approved == 'true' %}selected{% endif %}>–û–¥–æ–±—Ä–µ–Ω—ã</option>
                <option value="false" {% if is_approved == 'false' %}selected{% endif %}>–°–∫—Ä—ã—Ç—ã</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select name="sort_by" class="form-control">
                <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>–°—Ç–∞—Ä—ã–µ</option>
                <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
                <option value="product_id" {% if sort_by == 'product_id' %}selected{% endif %}>–ü–æ —Ç–æ–≤–∞—Ä—É</option>
            </select>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary" style="height: 42px;">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="{% url 'main:admin_reviews' %}" class="btn btn-secondary" style="height: 42px; margin-left: 10px;">
                –°–±—Ä–æ—Å–∏—Ç—å
            </a>
        </div>
    </form>
</div>

{% if reviews %}
<table class="admin-table">
    <thead>
        <tr>
            <th>–¢–æ–≤–∞—Ä</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–†–µ–π—Ç–∏–Ω–≥</th>
            <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
            <th>–î–∞—Ç–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for review in reviews %}
        <tr>
            <td>
                <strong>{{ review.product_id }}</strong>
            </td>
            <td>
                {{ review.user.username }}<br>
                <small>{{ review.user.email }}</small>
            </td>
            <td>
                <div style="color: #f1c40f; font-size: 1.2rem;">
                    {{ review.get_rating_stars }}
                </div>
                <small>{{ review.rating }}/5</small>
            </td>
            <td>
                <strong>{{ review.title|truncatechars:50 }}</strong><br>
                <small>{{ review.text|truncatechars:100 }}</small>
            </td>
            <td>{{ review.created_at|date:"d.m.Y H:i" }}</td>
            <td>
                <button onclick="toggleReviewApproval('{{ review.id }}', this)"
                        class="btn btn-{% if review.is_approved %}success{% else %}warning{% endif %} btn-sm">
                    {% if review.is_approved %}–û–¥–æ–±—Ä–µ–Ω{% else %}–°–∫—Ä—ã—Ç{% endif %}
                </button>
            </td>
            <td>
                <button onclick="deleteReview('{{ review.id }}')" class="btn btn-danger btn-sm">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if reviews.paginator.num_pages > 1 %}
<div class="pagination">
    {% if reviews.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ reviews.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </li>
    {% endif %}

    {% for num in reviews.paginator.page_range %}
    {% if num > reviews.number|add:-3 and num < reviews.number|add:3 %}
    <li class="page-item">
        <a class="page-link {% if reviews.number == num %}active{% endif %}"
           href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            {{ num }}
        </a>
    </li>
    {% endif %}
    {% endfor %}

    {% if reviews.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ reviews.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            –í–ø–µ—Ä–µ–¥ ‚Üí
        </a>
    </li>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="alert alert-info">
    üòê –û—Ç–∑—ã–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
</div>
{% endif %}
{% endblock %}