{% extends 'admin_panel/base.html' %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã{% endblock %}

{% block page_title %}üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ ({{ order_count }}){% endblock %}

{% block content %}
<div class="filters">
    <form method="get" class="filter-row">
        <div class="form-group">
            <label class="form-label">–ü–æ–∏—Å–∫</label>
            <input type="text" name="q" class="form-control" placeholder="–ù–æ–º–µ—Ä, –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω..."
                   value="{{ search_query }}">
        </div>

        <div class="form-group">
            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
            <select name="status" class="form-control">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                {% for key, value in STATUS_CHOICES %}
                <option value="{{ key }}" {% if status_filter == key %}selected{% endif %}>
                    {{ value }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–°</label>
            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
        </div>

        <div class="form-group">
            <label class="form-label">–ü–æ</label>
            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
        </div>

        <div class="form-group">
            <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select name="sort_by" class="form-control">
                <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>–ù–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>–°—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                <option value="order_number" {% if sort_by == 'order_number' %}selected{% endif %}>–ü–æ –Ω–æ–º–µ—Ä—É</option>
                <option value="final_amount" {% if sort_by == 'final_amount' %}selected{% endif %}>–ü–æ —Å—É–º–º–µ</option>
            </select>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary" style="height: 42px;">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="{% url 'main:admin_orders' %}" class="btn btn-secondary" style="height: 42px; margin-left: 10px;">
                –°–±—Ä–æ—Å–∏—Ç—å
            </a>
        </div>
    </form>
</div>

{% if orders %}
<table class="admin-table">
    <thead>
        <tr>
            <th>‚Ññ –∑–∞–∫–∞–∑–∞</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–î–∞—Ç–∞</th>
            <th>–°—É–º–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–û–ø–ª–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for order in orders %}
        <tr>
            <td><strong>#{{ order.order_number }}</strong></td>
            <td>
                {{ order.user.username }}<br>
                <small>{{ order.user.email }}</small>
            </td>
            <td>{{ order.created_at|date:"d.m.Y H:i" }}</td>
            <td><strong>{{ order.final_amount }} ‚ÇΩ</strong></td>
            <td>
                <select onchange="updateOrderStatus('{{ order.id }}', this.value)" class="form-control" style="width: auto;">
                    {% for key, value in STATUS_CHOICES %}
                    <option value="{{ key }}" {% if order.status == key %}selected{% endif %}>
                        {{ value }}
                    </option>
                    {% endfor %}
                </select>
            </td>
            <td>{{ order.get_payment_method_display }}</td>
            <td>
                <a href="{% url 'main:admin_order_detail' order.id %}" class="btn btn-primary btn-sm">
                    üëÅÔ∏è
                </a>
                <form action="{% url 'main:delete_order' order.id %}" method="post"
                      class="delete-form" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ #{{ order.order_number }}?')">
                        üóëÔ∏è
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if orders.paginator.num_pages > 1 %}
<div class="pagination">
    {% if orders.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ orders.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </li>
    {% endif %}

    {% for num in orders.paginator.page_range %}
    {% if num > orders.number|add:-3 and num < orders.number|add:3 %}
    <li class="page-item">
        <a class="page-link {% if orders.number == num %}active{% endif %}"
           href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            {{ num }}
        </a>
    </li>
    {% endif %}
    {% endfor %}

    {% if orders.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ orders.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            –í–ø–µ—Ä–µ–¥ ‚Üí
        </a>
    </li>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="alert alert-info">
    üòê –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
</div>
{% endif %}
{% endblock %}