{% extends 'admin_panel/base.html' %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block page_title %}üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ ({{ user_count }}){% endblock %}

{% block content %}
<div class="filters">
    <form method="get" class="filter-row">
        <div class="form-group">
            <label class="form-label">–ü–æ–∏—Å–∫</label>
            <input type="text" name="q" class="form-control" placeholder="–ò–º—è, email..."
                   value="{{ search_query }}">
        </div>

        <div class="form-group">
            <label class="form-label">–°—Ç–∞—Ç—É—Å staff</label>
            <select name="is_staff" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="true" {% if is_staff == 'true' %}selected{% endif %}>Staff</option>
                <option value="false" {% if is_staff == 'false' %}selected{% endif %}>–ù–µ staff</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
            <select name="is_active" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="true" {% if is_active == 'true' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="false" {% if is_active == 'false' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select name="sort_by" class="form-control">
                <option value="-date_joined" {% if sort_by == '-date_joined' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
                <option value="date_joined" {% if sort_by == 'date_joined' %}selected{% endif %}>–°—Ç–∞—Ä—ã–µ</option>
                <option value="username" {% if sort_by == 'username' %}selected{% endif %}>–ü–æ –∏–º–µ–Ω–∏</option>
                <option value="-last_login" {% if sort_by == '-last_login' %}selected{% endif %}>–ü–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
            </select>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary" style="height: 42px;">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="{% url 'main:admin_users' %}" class="btn btn-secondary" style="height: 42px; margin-left: 10px;">
                –°–±—Ä–æ—Å–∏—Ç—å
            </a>
        </div>
    </form>
</div>

{% if users %}
<table class="admin-table">
    <thead>
        <tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>Email</th>
            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>
                <strong>{{ user.username }}</strong><br>
                <small>{{ user.get_full_name|default:"–ë–µ–∑ –∏–º–µ–Ω–∏" }}</small>
            </td>
            <td>{{ user.email }}</td>
            <td>{{ user.date_joined|date:"d.m.Y" }}</td>
            <td>
                {% if user.last_login %}
                    {{ user.last_login|date:"d.m.Y H:i" }}
                {% else %}
                    –ù–∏–∫–æ–≥–¥–∞
                {% endif %}
            </td>
            <td>
                {% if user.is_superuser %}
                    <span class="badge" style="background: #e74c3c; color: white;">–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                {% elif user.is_staff %}
                    <span class="badge" style="background: #3498db; color: white;">Staff</span>
                {% else %}
                    <span class="badge" style="background: #95a5a6; color: white;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                {% endif %}

                {% if user.is_active %}
                    <span class="badge" style="background: #27ae60; color: white;">–ê–∫—Ç–∏–≤–µ–Ω</span>
                {% else %}
                    <span class="badge" style="background: #e74c3c; color: white;">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                {% endif %}
            </td>
            <td>
                <small>
                    üì¶ {{ user.order_count }} –∑–∞–∫–∞–∑–æ–≤<br>
                    ‚≠ê {{ user.review_count }} –æ—Ç–∑—ã–≤–æ–≤
                </small>
            </td>
            <td>
                {% if not user.is_superuser %}
                <button onclick="toggleStaffStatus('{{ user.id }}', this)"
                        class="btn btn-{% if user.is_staff %}success{% else %}secondary{% endif %} btn-sm">
                    Staff: {% if user.is_staff %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                </button>
                {% else %}
                <span class="btn btn-sm disabled">–°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if users.paginator.num_pages > 1 %}
<div class="pagination">
    {% if users.has_previous %}
    <li class="page-item">
        <a class="page-link" href="?page={{ users.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    </li>
    {% endif %}

    {% for num in users.paginator.page_range %}
    {% if num > users.number|add:-3 and num < users.number|add:3 %}
    <li class="page-item">
        <a class="page-link {% if users.number == num %}active{% endif %}"
           href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            {{ num }}
        </a>
    </li>
    {% endif %}
    {% endfor %}

    {% if users.has_next %}
    <li class="page-item">
        <a class="page-link" href="?page={{ users.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            –í–ø–µ—Ä–µ–¥ ‚Üí
        </a>
    </li>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="alert alert-info">
    üòê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
</div>
{% endif %}
{% endblock %}